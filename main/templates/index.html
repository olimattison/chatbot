{% extends "base.html" %}

{% block title %}Chat - Llama Chat{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="main-layout">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3><i class="fas fa-history"></i> Recent Sessions</h3>
    </div>
    <div class="sidebar-content">
      <button class="new-session-btn" onclick="createNewSession()">
        <i class="fas fa-plus"></i> New Chat
      </button>
      
      <div id="sessions-list">
        {% if recent_sessions %}
          {% for session in recent_sessions %}
          <div class="session-item {% if session.id == active_session.id %}active{% endif %}" 
               data-session-id="{{ session.id }}" onclick="loadSession({{ session.id }})">
            <div class="session-title">{{ session.title or "New Chat" }}</div>
            <div class="session-meta">
              <span>{{ session.formatted_date() }}</span>
              <span>{{ session.message_count() }} messages</span>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-sessions">
            <i class="fas fa-comments"></i>
            <p>No chat sessions yet</p>
            <p class="text-muted">Start a new conversation!</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <div class="chat-wrapper">
      <!-- Model Selector -->
      <div class="model-selector">
        <label for="model-select">
          <i class="fas fa-brain"></i> Model:
        </label>
        <select id="model-select" onchange="changeModel(this.value)">
          {% for model in available_models %}
          <option value="{{ model.name }}" {% if active_session.model_used == model.name %}selected{% endif %}>
            {{ model.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Messages Area -->
      <div class="messages-container" id="messages-container">
        <div class="welcome-message">
          <div class="message bot">
            <div class="message-content">
              <h3>Hello!</h3>
              <p>How can I help you today?</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="input-container">
        <div class="input-wrapper">
          <textarea 
            id="user-input" 
            class="input-field" 
            placeholder="Type your message here..."
            rows="1"
            onkeydown="handleKeyPress(event)"
          ></textarea>
        </div>
        <button id="send-btn" class="send-btn" onclick="sendMessage()" disabled>
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Global variables
  let currentSessionId = {{ active_session.id }};
  let isTyping = false;
  let currentModel = '{{ active_session.model_used }}';

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    loadSessionMessages(currentSessionId);
    setupInputField();
  });

  // Input field setup
  function setupInputField() {
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
      
      sendBtn.disabled = !this.value.trim();
    });
  }

  // Handle Enter key
  function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  }

  // Send message
  async function sendMessage() {
    const input = document.getElementById('user-input');
    const message = input.value.trim();
    
    if (!message || isTyping) return;

    // Add user message to UI
    addMessageToUI('user', message);
    input.value = '';
    input.style.height = 'auto';
    document.getElementById('send-btn').disabled = true;

    // Show typing indicator
    showTypingIndicator();

    try {
      const response = await fetch('/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          prompt: message,
          model: currentModel,
          session_id: currentSessionId
        })
      });

      const data = await response.json();
      hideTypingIndicator();

      if (data.error) {
        addMessageToUI('bot', `Error: ${data.error}`, true);
      } else {
        addMessageToUI('bot', data.response, false, currentModel);
        
        // Update session in sidebar if this is a new session
        if (data.session_id && data.session_id !== currentSessionId) {
          currentSessionId = data.session_id;
          updateSidebarSession(data.session_id, message);
        } else if (currentSessionId) {
          // Update existing session in sidebar
          updateExistingSessionInSidebar(currentSessionId);
        }
      }
    } catch (error) {
      hideTypingIndicator();
      addMessageToUI('bot', 'Sorry, there was an error processing your request.', true);
    }
  }

  // Add message to UI
  function addMessageToUI(role, content, isError = false, modelName = null) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isError) {
      contentDiv.innerHTML = `<p style="color: var(--error);">${content}</p>`;
    } else {
      let messageContent = marked.parse(content);
      
      // Add model name at the top for bot responses
      if (role === 'bot' && modelName) {
        messageContent = `<div class="model-indicator"><small><strong>${modelName}</strong></small></div>${messageContent}`;
      }
      
      contentDiv.innerHTML = messageContent;
    }
    
    messageDiv.appendChild(contentDiv);
    container.appendChild(messageDiv);
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
  }

  // Show typing indicator
  function showTypingIndicator() {
    isTyping = true;
    const container = document.getElementById('messages-container');
    const indicator = document.createElement('div');
    indicator.className = 'message bot typing-indicator';
    indicator.id = 'typing-indicator';
    indicator.innerHTML = `
      <div class="message-content">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span>Thinking...</span>
      </div>
    `;
    container.appendChild(indicator);
    container.scrollTop = container.scrollHeight;
  }

  // Hide typing indicator
  function hideTypingIndicator() {
    isTyping = false;
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
      indicator.remove();
    }
  }

  // Load session messages
  async function loadSessionMessages(sessionId) {
    try {
      const response = await fetch(`/api/session/${sessionId}/messages`);
      const data = await response.json();
      
      const container = document.getElementById('messages-container');
      container.innerHTML = '';
      
      if (data.messages && data.messages.length > 0) {
        data.messages.forEach(msg => {
          // For existing messages, we don't have the model name, so we'll skip it
          addMessageToUI(msg.role, msg.content);
        });
      } else {
        // Show welcome message for empty sessions
        container.innerHTML = `
          <div class="welcome-message">
            <div class="message bot">
              <div class="message-content">
                <h3>Hello!</h3>
                <p>How can I help you today?</p>
              </div>
            </div>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading messages:', error);
    }
  }

  // Load session
  function loadSession(sessionId) {
    currentSessionId = sessionId;
    
    // Update active state in sidebar
    document.querySelectorAll('.session-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`[data-session-id="${sessionId}"]`).classList.add('active');
    
    // Load messages
    loadSessionMessages(sessionId);
  }

  // Create new session
  function createNewSession() {
    currentSessionId = null;
    
    // Clear messages
    const container = document.getElementById('messages-container');
    container.innerHTML = `
      <div class="welcome-message">
        <div class="message bot">
          <div class="message-content">
            <h3>Hello!</h3>
            <p>How can I help you today?</p>
          </div>
        </div>
      </div>
    `;
    
    // Update sidebar
    document.querySelectorAll('.session-item').forEach(item => {
      item.classList.remove('active');
    });
  }

  // Change model
  function changeModel(model) {
    currentModel = model;
  }

  // Update sidebar session
  function updateSidebarSession(sessionId, firstMessage) {
    const sessionsList = document.getElementById('sessions-list');
    const newSessionItem = document.createElement('div');
    newSessionItem.className = 'session-item active';
    newSessionItem.setAttribute('data-session-id', sessionId);
    newSessionItem.onclick = () => loadSession(sessionId);
    
    const title = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
    
    newSessionItem.innerHTML = `
      <div class="session-title">${title}</div>
      <div class="session-meta">
        <span>Today</span>
        <span>1 message</span>
      </div>
    `;
    
    // Remove active class from other sessions
    document.querySelectorAll('.session-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // Add new session at the top
    const newSessionBtn = sessionsList.querySelector('.new-session-btn');
    sessionsList.insertBefore(newSessionItem, newSessionBtn.nextSibling);
  }

  // Update existing session in sidebar
  function updateExistingSessionInSidebar(sessionId) {
    const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
    if (sessionItem) {
      // Update active state
      document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
      });
      sessionItem.classList.add('active');
      
      // Update message count (this would need to be fetched from the server)
      // For now, we'll just update the timestamp
      const metaElement = sessionItem.querySelector('.session-meta span:first-child');
      if (metaElement) {
        metaElement.textContent = 'Just now';
      }
    }
  }
</script>
{% endblock %}
